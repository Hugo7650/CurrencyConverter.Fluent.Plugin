using System.Globalization;using System.Runtime.CompilerServices;using System.Text.Json;using System.Text.RegularExpressions;using Blast.API.Core.Processes;using Blast.API.Processes;using Blast.Core;using Blast.Core.Interfaces;using Blast.Core.Objects;using Blast.Core.Results;using Blast.API.Search.SearchOperations;namespace CurrencyConverter.Fluent.Plugin{    public class CurrencyConversionSearchApp : ISearchApplication    {        private const string SearchAppName = "CurrencyConverter";        private const string ApiBaseUrl = "https://latest.currency-api.pages.dev/v1/currencies";                private readonly List<SearchTag> _searchTags;        private readonly SearchApplicationInfo _applicationInfo;        private readonly List<ISearchOperation> _supportedOperations;        private readonly Regex _currencyRegex = new Regex(@"^(\d+(?:\.\d+)?)\s*([a-z]{3})\s*(?:to|in)\s*([a-z]{3})$",             RegexOptions.IgnoreCase | RegexOptions.Compiled);        // Currency codes for better UX        private readonly HashSet<string> _currencies = new HashSet<string>(StringComparer.OrdinalIgnoreCase)        {            "1inch",            "aave",            "ada",            "aed",            "afn",            "agix",            "akt",            "algo",            "all",            "amd",            "amp",            "ang",            "aoa",            "ape",            "apt",            "ar",            "arb",            "ars",            "atom",            "ats",            "aud",            "avax",            "awg",            "axs",            "azm",            "azn",            "bake",            "bam",            "bat",            "bbd",            "bch",            "bdt",            "bef",            "bgn",            "bhd",            "bif",            "bmd",            "bnb",            "bnd",            "bob",            "brl",            "bsd",            "bsv",            "bsw",            "btc",            "btcb",            "btg",            "btn",            "btt",            "busd",            "bwp",            "byn",            "byr",            "bzd",            "cad",            "cake",            "cdf",            "celo",            "cfx",            "chf",            "chz",            "clp",            "cnh",            "cny",            "comp",            "cop",            "crc",            "cro",            "crv",            "cspr",            "cuc",            "cup",            "cve",            "cvx",            "cyp",            "czk",            "dai",            "dash",            "dcr",            "dem",            "dfi",            "djf",            "dkk",            "doge",            "dop",            "dot",            "dydx",            "dzd",            "eek",            "egld",            "egp",            "enj",            "eos",            "ern",            "esp",            "etb",            "etc",            "eth",            "eur",            "eurc",            "fei",            "fil",            "fim",            "fjd",            "fkp",            "flow",            "flr",            "frax",            "frf",            "ftt",            "gala",            "gbp",            "gel",            "ggp",            "ghc",            "ghs",            "gip",            "gmd",            "gmx",            "gnf",            "gno",            "grd",            "grt",            "gt",            "gtq",            "gusd",            "gyd",            "hbar",            "hkd",            "hnl",            "hnt",            "hot",            "hrk",            "ht",            "htg",            "huf",            "icp",            "idr",            "iep",            "ils",            "imp",            "imx",            "inj",            "inr",            "iqd",            "irr",            "isk",            "itl",            "jep",            "jmd",            "jod",            "jpy",            "kas",            "kava",            "kcs",            "kda",            "kes",            "kgs",            "khr",            "klay",            "kmf",            "knc",            "kpw",            "krw",            "ksm",            "kwd",            "kyd",            "kzt",            "lak",            "lbp",            "ldo",            "leo",            "link",            "lkr",            "lrc",            "lrd",            "lsl",            "ltc",            "ltl",            "luf",            "luna",            "lunc",            "lvl",            "lyd",            "mad",            "mana",            "mbx",            "mdl",            "mga",            "mgf",            "mina",            "mkd",            "mkr",            "mmk",            "mnt",            "mop",            "mro",            "mru",            "mtl",            "mur",            "mvr",            "mwk",            "mxn",            "mxv",            "myr",            "mzm",            "mzn",            "nad",            "near",            "neo",            "nexo",            "nft",            "ngn",            "nio",            "nlg",            "nok",            "npr",            "nzd",            "okb",            "omr",            "one",            "op",            "ordi",            "pab",            "paxg",            "pen",            "pepe",            "pgk",            "php",            "pkr",            "pln",            "pol",            "pte",            "pyg",            "qar",            "qnt",            "qtum",            "rol",            "ron",            "rpl",            "rsd",            "rub",            "rune",            "rvn",            "rwf",            "sand",            "sar",            "sbd",            "scr",            "sdd",            "sdg",            "sek",            "sgd",            "shib",            "shp",            "sit",            "skk",            "sle",            "sll",            "snx",            "sol",            "sos",            "spl",            "srd",            "srg",            "std",            "stn",            "stx",            "sui",            "svc",            "syp",            "szl",            "thb",            "theta",            "tjs",            "tmm",            "tmt",            "tnd",            "ton",            "top",            "trl",            "trx",            "try",            "ttd",            "tusd",            "tvd",            "twd",            "twt",            "tzs",            "uah",            "ugx",            "uni",            "usd",            "usdc",            "usdd",            "usdp",            "usdt",            "uyu",            "uzs",            "val",            "veb",            "ved",            "vef",            "ves",            "vet",            "vnd",            "vuv",            "waves",            "wemix",            "woo",            "wst",            "xaf",            "xag",            "xau",            "xaut",            "xbt",            "xcd",            "xcg",            "xch",            "xdc",            "xdr",            "xec",            "xem",            "xlm",            "xmr",            "xof",            "xpd",            "xpf",            "xpt",            "xrp",            "xtz",            "yer",            "zar",            "zec",            "zil",            "zmk",            "zmw",            "zwd",            "zwg",            "zwl"        };        private readonly CurrencyConverterSearchAppSettings _currencyConverterSearchAppSettings;        public CurrencyConversionSearchApp()        {            _searchTags = new List<SearchTag>            {                new SearchTag { Name = "currency", IconGlyph = "\uE8AB", Description = "Convert currencies" },                new SearchTag { Name = "convert", IconGlyph = "\uE8AB", Description = "Currency conversion" },                new SearchTag { Name = "exchange", IconGlyph = "\uE8AB", Description = "Exchange rates" }            };            _supportedOperations = new List<ISearchOperation>            {                new CopySearchOperation("Copy Result"),                CurrencyConversionSearchOperation.OpenExchangeRateOperation            };            _applicationInfo = new SearchApplicationInfo(SearchAppName,                "Convert currencies using live exchange rates", _supportedOperations)            {                MinimumSearchLength = 6, // Minimum length for "1 USD to EUR"                IsProcessSearchEnabled = false,                IsProcessSearchOffline = false,                ApplicationIconGlyph = "\uE8AB",                SearchAllTime = ApplicationSearchTime.Slow, // Network requests can be slow                DefaultSearchTags = _searchTags            };                        _applicationInfo.SettingsPage = _currencyConverterSearchAppSettings = new CurrencyConverterSearchAppSettings(_applicationInfo);        }        public ValueTask LoadSearchApplicationAsync()        {            return ValueTask.CompletedTask;        }        public SearchApplicationInfo GetApplicationInfo()        {            return _applicationInfo;        }        public async IAsyncEnumerable<ISearchResult> SearchAsync(SearchRequest searchRequest,            [EnumeratorCancellation] CancellationToken cancellationToken)        {            if (cancellationToken.IsCancellationRequested || searchRequest.SearchType == SearchType.SearchProcess)                yield break;            string searchedTag = searchRequest.SearchedTag;            string searchedText = searchRequest.SearchedText;            // Check if the search tag is something this app can handle            if (!string.IsNullOrWhiteSpace(searchedTag))            {                if (!searchedTag.Equals(SearchAppName, StringComparison.OrdinalIgnoreCase) &&                    !searchedTag.Equals("currency", StringComparison.OrdinalIgnoreCase) &&                    !searchedTag.Equals("convert", StringComparison.OrdinalIgnoreCase) &&                    !searchedTag.Equals("exchange", StringComparison.OrdinalIgnoreCase))                    yield break;            }            // Parse the search text for currency conversion pattern            var match = _currencyRegex.Match(searchedText);            if (!match.Success)                yield break;            if (!double.TryParse(match.Groups[1].Value, NumberStyles.Float, CultureInfo.InvariantCulture, out double amount))                yield break;            string fromCurrency = match.Groups[2].Value.ToUpperInvariant();            string toCurrency = match.Groups[3].Value.ToUpperInvariant();            // Perform the currency conversion            await foreach (var result in ConvertCurrencyAsync(amount, fromCurrency, toCurrency, searchedText, cancellationToken))            {                yield return result;            }        }        private async IAsyncEnumerable<ISearchResult> ConvertCurrencyAsync(double amount, string fromCurrency,             string toCurrency, string searchedText, [EnumeratorCancellation] CancellationToken cancellationToken)        {            using var httpClient = new HttpClient();            httpClient.Timeout = TimeSpan.FromSeconds(5);            // Fetch exchange rates for the base currency            string apiUrl = $"{ApiBaseUrl}/{fromCurrency.ToLowerInvariant()}.json";            var response = await httpClient.GetAsync(apiUrl, cancellationToken);            if (!response.IsSuccessStatusCode)                yield break;            var jsonContent = await response.Content.ReadAsStringAsync(cancellationToken);            var apiResponse = JsonSerializer.Deserialize<CurrencyApiResponse>(jsonContent,                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });            if (apiResponse == null)                yield break;            // Get exchange rates for the base currency            var exchangeRates = apiResponse.GetExchangeRates(fromCurrency);            if (exchangeRates == null)                yield break;            // Find the exchange rate for the target currency            string targetCurrencyKey = toCurrency.ToLowerInvariant();            if (!exchangeRates.TryGetValue(targetCurrencyKey, out double exchangeRate))                yield break;            double convertedAmount = amount * exchangeRate;            // Calculate relevance score based on currency popularity            double score = CalculateRelevanceScore(fromCurrency, toCurrency);            // Get localized currency names            var languageManager = LanguageManager.Instance;            string fromCurrencyName = languageManager.GetCurrencyName(fromCurrency);            string toCurrencyName = languageManager.GetCurrencyName(toCurrency);            string resultName = $"{amount} {fromCurrencyName} = {convertedAmount} {toCurrencyName}";            string resultDescription = $"{amount} {fromCurrencyName} = {convertedAmount} {toCurrencyName}";            string resultType = "Currency Conversion";            // Create operations list with basic operations            var operations = new List<ISearchOperation>            {                new CopySearchOperation("Copy Result"),                CurrencyConversionSearchOperation.OpenExchangeRateOperation            };            // Add other popular currency conversions as operations            var enabledCurrencies = _currencyConverterSearchAppSettings.PopularCurrencies                .Where(c => c.IsEnabled &&                            !c.Code.Equals(fromCurrency, StringComparison.OrdinalIgnoreCase) &&                            !c.Code.Equals(toCurrency, StringComparison.OrdinalIgnoreCase));            foreach (var currencyItem in enabledCurrencies)            {                if (exchangeRates.TryGetValue(currencyItem.Code.ToLowerInvariant(), out double rate))                {                    double otherConvertedAmount = amount * rate;                    string otherCurrencyName = languageManager.GetCurrencyName(currencyItem.Code);                    operations.Add(CurrencyConversionSearchOperation.CreateConversionOperation(                        currencyItem.Code, otherCurrencyName, amount, otherConvertedAmount));                }            }            var searchResult = new CurrencyConversionSearchResult(                amount, fromCurrency, toCurrency, convertedAmount,                SearchAppName, resultName, searchedText, resultType, score,                operations, _searchTags)            {                ResultDescription = resultDescription            };            yield return searchResult;        }        private double CalculateRelevanceScore(string fromCurrency, string toCurrency)        {            double score = 1.0;                        // Boost score for common currencies            if (_currencies.Contains(fromCurrency))                score += 0.5;            if (_currencies.Contains(toCurrency))                score += 0.5;                            return score;        }        public ValueTask<ISearchResult> GetSearchResultForId(object searchObjectId)        {            // This can be implemented to support custom tags if needed            return new ValueTask<ISearchResult>();        }        public ValueTask<IHandleResult> HandleSearchResult(ISearchResult searchResult)        {            if (!(searchResult is CurrencyConversionSearchResult currencyResult))            {                throw new InvalidCastException(nameof(CurrencyConversionSearchResult));            }            if (!(currencyResult.SelectedOperation is CurrencyConversionSearchOperation conversionOperation))            {                throw new InvalidCastException(nameof(CurrencyConversionSearchOperation));            }            // Get Fluent Search process manager instance            IProcessManager managerInstance = ProcessUtils.GetManagerInstance();                        // Open exchange rates website            managerInstance.StartNewProcess($"https://www.xe.com/currencyconverter/convert/?Amount={currencyResult.Amount}&From={currencyResult.FromCurrency}&To={currencyResult.ToCurrency}");            return new ValueTask<IHandleResult>(new HandleResult(true, false));        }    }}